<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>北海道 市町村 人口ヒートマップ（完全フル版）</title>
  <style>
    body { margin:0; font-family:sans-serif; }
    #map { width:100%; height:100vh; }
    .tooltip {
      position:absolute;
      padding:4px 8px;
      background:rgba(0,0,0,0.75);
      color:#fff;
      border-radius:4px;
      font-size:12px;
      pointer-events:none;
      white-space:nowrap;
      opacity:0;
      transition:opacity .1s;
    }
  </style>
</head>
<body>
<svg id="map" viewBox="0 0 1000 800"></svg>
<div id="tooltip" class="tooltip"></div>

<script>
// —————————————————————————
// 1) 北海道 市町村境界 GeoJSON（完全版）をここに埋め込んでください。
// 例：Geoshape（NII）最新「北海道」GeoJSON を丸ごとコピーして `geoData = {...}` に貼り込む。
// —————————————————————————
const geoData = {
  "type": "FeatureCollection",
  "features": [
    /* ここに膨大な Feature が続きます。
       例:
       {
         "type": "Feature",
         "properties": {
           "N03_007": "01100",
           "N03_004": "札幌市",
           ...（他属性）...
         },
         "geometry": {
           "type": "Polygon",
           "coordinates": [...]
         }
       },
       ...
    */
  ]
};

// —————————————————————————
// 2) 人口データをコード‐値で埋め込み（例です。別途最新データに差し替えてください）
// —————————————————————————
const popData = {
  "01100": 1952356,
  "01202": 330331,
  // ... 北海道各自治体の JIS コード（行政区域コード）と人口 ...
};

// —————————————————————————
// 3) 投影（緯度経度 → SVG 座標変換）
// —————————————————————————
function project([lon, lat]) {
  const λmin = 139, λmax = 146;    // 緯度・経度の概範囲（北海道全域）
  const φmin = 41, φmax = 45.5;
  const w = 1000, h = 800;
  const x = (lon - λmin) / (λmax - λmin) * w;
  const y = (φmax - lat) / (φmax - φmin) * h;
  return [x, y];
}

// —————————————————————————
// 4) カラースケール設定（人口に応じて RGB グラデーション）
// —————————————————————————
function getColor(val, vmin, vmax) {
  if (val == null) return '#999';
  const t = Math.max(0, Math.min(1, (val - vmin) / (vmax - vmin)));
  const r = Math.round(255 * t);
  const g = Math.round(200 * (1 - t));
  const b = Math.round(150 * (1 - t));
  return `rgb(${r},${g},${b})`;
}

// —————————————————————————
// 5) 描画ロジック
// —————————————————————————
const svg = document.getElementById('map');
const tooltip = document.getElementById('tooltip');
const pops = Object.values(popData).filter(v => typeof v === 'number');
const vmin = Math.min(...pops);
const vmax = Math.max(...pops);

geoData.features.forEach(f => {
  const coordsArr = (f.geometry.type === 'Polygon')
    ? [f.geometry.coordinates]
    : f.geometry.coordinates;  // MultiPolygon 対応

  let d = '';
  coordsArr.forEach(polygon => {
    polygon.forEach(ring => {
      ring.forEach((pt, i) => {
        const [x, y] = project(pt);
        d += (i === 0 ? 'M' : 'L') + x + ' ' + y;
      });
      d += 'Z';
    });
  });

  const code = f.properties.N03_007 || f.properties.code || '';
  const name = f.properties.N03_004 || f.properties.name || '(名称不明)';
  const pop = popData[code] ?? null;
  const fill = getColor(pop, vmin, vmax);

  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', d);
  path.setAttribute('fill', fill);
  path.setAttribute('stroke', '#333');
  path.setAttribute('stroke-width', '0.3');
  svg.appendChild(path);

  path.addEventListener('mousemove', e => {
    tooltip.style.left = (e.pageX + 10) + 'px';
    tooltip.style.top = (e.pageY + 10) + 'px';
    tooltip.innerHTML = `${name} (${code})<br>人口: ${pop != null ? pop.toLocaleString() : 'データなし'}`;
    tooltip.style.opacity = 1;
  });
  path.addEventListener('mouseleave', () => {
    tooltip.style.opacity = 0;
  });
});
</script>
</body>
</html>
