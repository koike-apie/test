<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>北海道 各市町村の人口可視化（コロプレス）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
  <style>
    html, body { height: 100%; margin: 0; }
    #app { height: 100%; display: grid; grid-template-rows: auto 1fr; }
    header {
      display: flex; gap: 12px; align-items: center; padding: 10px 12px;
      background: #0b1220; color: #fff; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,.2);
    }
    header h1 { font-size: 16px; font-weight: 700; margin: 0 8px 0 0; }
    header .muted { opacity:.7; font-weight: 500; }
    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .controls label { font-size: 12px; opacity:.9 }
    .controls input[type="file"] { display: none; }
    .btn { appearance: none; border: 1px solid rgba(255,255,255,.2); background: #141c2f; color: #fff; padding: 8px 10px; border-radius: 10px; font-size: 12px; cursor: pointer; }
    .btn:hover { background: #1b2540; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }

    #map { width: 100%; height: 100%; }

    .legend {
      position: absolute; bottom: 14px; left: 14px; background: #fff; padding: 10px 12px; border-radius: 12px; box-shadow: 0 4px 18px rgba(0,0,0,.18); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif; font-size: 12px;
    }
    .legend .scale { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; margin-top: 6px; }
    .legend .box { height: 12px; border-radius: 3px; border: 1px solid rgba(0,0,0,.12) }
    .legend .ticks { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; margin-top: 4px; color: #555; }
    .legend .ticks span { transform: translateX(-8%); }

    .infocard { position: absolute; top: 14px; left: 14px; background: #fff; padding: 10px 12px; border-radius: 12px; box-shadow: 0 4px 18px rgba(0,0,0,.18); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif; }
    .infocard .title { font-size: 14px; font-weight: 700; }
    .infocard .subtitle { font-size: 12px; color: #666; }
    .infocard .big { font-size: 20px; font-weight: 800; margin-top: 4px; }
    .loading { position: absolute; inset: 0; display: grid; place-items: center; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif; font-weight: 600; color: #334; background: linear-gradient(180deg,#f9fbff,#f2f6ff); }

    .source { position: absolute; bottom: 14px; right: 14px; background: rgba(255,255,255,.92); padding: 8px 10px; border-radius: 10px; font-size: 11px; color: #333; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif; box-shadow: 0 4px 18px rgba(0,0,0,.12); }
    .source a { color: #0f5; color: #0a58ca; text-decoration: none; }

    .leaflet-tooltip { font-size: 12px; }
    .leaflet-container { background: #eef5ff; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>北海道・市町村 人口コロプレス</h1>
      <span class="muted">（2020年基準・推定）</span>
      <div class="controls">
        <label class="btn" for="fileInput">人口CSVを読み込む（任意・上書き）</label>
        <input id="fileInput" type="file" accept=".csv" />
        <button id="resetBtn" class="btn" title="初期データに戻す">初期データに戻す</button>
      </div>
    </header>
    <div id="map"></div>
    <div class="infocard" id="infocard">
      <div class="title">地域</div>
      <div class="big" id="areaName">-</div>
      <div class="subtitle">人口</div>
      <div class="big" id="areaPop">-</div>
    </div>
    <div class="legend" id="legend" aria-label="カラースケール凡例"></div>
    <div class="source">
      出典：<a href="https://www.harp.lg.jp/opendata/dataset/1379.html" target="_blank" rel="noopener">北海道オープンデータ（市町村ポリゴン）</a>／
      <a href="https://gist.github.com/sorami/cbadd6eb99d5eabb76a56dc654a87171" target="_blank" rel="noopener">人口（hokkaido.csv）</a>
    </div>
    <div class="loading" id="loading">データを読み込み中…</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <script>
  // === 外部データ ===
  const GEOJSON_URL = 'https://www.harp.lg.jp/opendata/dataset/1379/resource/2854/hokkaido_map_web_4612.geojson';
  // 人口CSV（列：city, lat, lon, population, ...）
  const POP_URL = 'https://gist.githubusercontent.com/sorami/cbadd6eb99d5eabb76a56dc654a87171/raw/be90ea460d387c908215e3d6dd9b90236fec9f7e/hokkaido.csv';

  // === ユーティリティ ===
  const fmt = new Intl.NumberFormat('ja-JP');
  function parseCSV(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(!lines.length) return [];
    const header = lines[0].split(/,|\t|\s{2,}/).map(h=>h.trim());
    const rows = [];
    for(let i=1;i<lines.length;i++){
      const raw = lines[i];
      // CSV or whitespace separated
      const cols = raw.includes(',') ? raw.split(',') : raw.split(/\t|\s{2,}/);
      if(cols.length<2) continue;
      const rec = {};
      header.forEach((h,idx)=>rec[h]= (cols[idx]||'').trim());
      rows.push(rec);
    }
    return rows;
  }

  function inferName(props){
    // 代表的なキー候補
    const candidates = ['name','name_ja','NAM','CITY','CITY_NAME','市町村名','N03_004','N03_003','N03_007','S_NAME','moji'];
    for(const k of candidates){ if(props[k]) return String(props[k]); }
    // 候補探索：値が「市/町/村/区」で終わるもの
    for(const [k,v] of Object.entries(props)){
      if(typeof v === 'string' && /[市町村区]$/.test(v)) return v;
    }
    // それでも無ければ最初の文字列
    for(const [k,v] of Object.entries(props)){
      if(typeof v === 'string') return v;
    }
    return '';
  }

  // 線形グラデーション（HSL）
  function lerp(a,b,t){ return a + (b-a)*t; }
  function colorScale(value, min, max){
    if(value==null || isNaN(value)) return '#e0e6f5';
    const t = (value - min) / (max - min + 1e-9);
    const h = 220; // 青系
    const s = 70;  // %
    const l = lerp(92, 32, Math.min(Math.max(t,0),1)); // 明→暗
    return `hsl(${h} ${s}% ${l}%)`;
  }

  function quantiles(arr, n=5){
    const xs = arr.slice().sort((a,b)=>a-b);
    const qs = [];
    for(let i=0;i<=n;i++){
      const p = i/n * (xs.length-1);
      const lo = Math.floor(p), hi = Math.ceil(p);
      const v = lo===hi ? xs[lo] : xs[lo] + (xs[hi]-xs[lo])*(p-lo);
      qs.push(v);
    }
    return qs;
  }

  // === 地図初期化 ===
  const map = L.map('map', { zoomControl: true, attributionControl: false });
  // 北海道にフィット
  const hkBounds = [[41.2,139.2],[45.8,146.2]]; // [S,W]-[N,E]
  map.fitBounds(hkBounds);
  // 背景タイル（標準のOSM）
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 12,
    minZoom: 5,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const state = {
    popByName: new Map(),
    nameByFid: new Map(),
    min: 0,
    max: 0,
    layer: null,
    breaks: [],
  };

  function setLegend(){
    const el = document.getElementById('legend');
    el.innerHTML = '';
    const title = document.createElement('div');
    title.textContent = '人口（人）';
    el.appendChild(title);
    const scale = document.createElement('div');
    scale.className = 'scale';
    const ticksWrap = document.createElement('div');
    ticksWrap.className = 'ticks';

    const [b0,b1,b2,b3,b4,b5] = state.breaks;
    const samples = [b0,b1,b2,b3,b4,b5];
    for(let i=0;i<5;i++){
      const v0 = samples[i], v1 = samples[i+1];
      const mid = (v0+v1)/2;
      const box = document.createElement('div');
      box.className = 'box';
      box.style.background = colorScale(mid, state.min, state.max);
      scale.appendChild(box);
      const tick = document.createElement('span');
      tick.textContent = fmt.format(Math.round(v0));
      ticksWrap.appendChild(tick);
    }
    const lastTick = document.createElement('span');
    lastTick.textContent = fmt.format(Math.round(samples[5]));
    ticksWrap.appendChild(lastTick);
    el.appendChild(scale);
    el.appendChild(ticksWrap);
  }

  function styleFeature(f){
    const name = inferName(f.properties);
    const pop = state.popByName.get(name);
    const fillColor = colorScale(pop, state.min, state.max);
    return {
      weight: 0.8,
      color: '#4a5a83',
      opacity: 0.6,
      fillColor,
      fillOpacity: 0.85
    };
  }

  function handleFeature(f, layer){
    const name = inferName(f.properties);
    const pop = state.popByName.get(name);
    const popStr = pop!=null ? fmt.format(pop) : 'データなし';
    layer.bindTooltip(`${name}<br>人口：${popStr}`, { sticky: true });
    layer.on('mouseover', ()=>{
      document.getElementById('areaName').textContent = name;
      document.getElementById('areaPop').textContent = popStr;
      layer.setStyle({ weight: 2, opacity: 0.9 });
    });
    layer.on('mouseout', ()=>{
      layer.setStyle({ weight: 0.8, opacity: 0.6 });
    });
    state.nameByFid.set(L.stamp(layer), name);
  }

  async function loadDefaultPopulation(){
    const txt = await fetch(POP_URL).then(r=>r.text());
    const rows = parseCSV(txt);
    const popByName = new Map();
    for(const r of rows){
      const name = (r.city || r.市区町村名 || r.名称 || '').trim();
      const p = Number((r.population||r.人口||'').toString().replace(/[,\s]/g,''));
      if(name && Number.isFinite(p)) popByName.set(name, p);
    }
    return popByName;
  }

  function recomputeBreaks(){
    const vals = [...state.popByName.values()].filter(v=>Number.isFinite(v));
    state.min = Math.min(...vals);
    state.max = Math.max(...vals);
    state.breaks = quantiles(vals, 5);
  }

  function redrawLayer(geojson){
    if(state.layer){ state.layer.remove(); state.layer = null; }
    state.layer = L.geoJSON(geojson, {
      style: styleFeature,
      onEachFeature: handleFeature
    }).addTo(map);
  }

  async function boot(){
    try{
      const [geojson, popMap] = await Promise.all([
        fetch(GEOJSON_URL).then(r=>r.json()),
        loadDefaultPopulation()
      ]);
      state.popByName = popMap;
      recomputeBreaks();
      setLegend();
      redrawLayer(geojson);
    }catch(err){
      alert('データの読み込みに失敗しました。ネットワーク接続やCORSを確認してください。\n'+err);
    }finally{
      document.getElementById('loading').style.display = 'none';
    }
  }

  // CSVアップロード（任意）：列は「市区町村名,人口」の2列でOK
  document.getElementById('fileInput').addEventListener('change', async (ev)=>{
    const file = ev.target.files?.[0];
    if(!file) return;
    const text = await file.text();
    const rows = parseCSV(text);
    const mapTmp = new Map();
    for(const r of rows){
      const name = (r.city || r.市区町村名 || r.名称 || r.name || r[Object.keys(r)[0]] || '').trim();
      const valRaw = r.population || r.人口 || r.value || r[Object.keys(r)[1]] || '';
      const p = Number(String(valRaw).replace(/[,\s]/g,''));
      if(name && Number.isFinite(p)) mapTmp.set(name, p);
    }
    if(mapTmp.size===0){ alert('人口データが読み取れませんでした。列名や区切り文字をご確認ください。'); return; }
    state.popByName = mapTmp;
    recomputeBreaks();
    setLegend();
    // 再色塗り
    state.layer.eachLayer(l=>{
      const name = state.nameByFid.get(L.stamp(l));
      const pop = state.popByName.get(name);
      l.setStyle({ fillColor: colorScale(pop, state.min, state.max) });
    });
  });

  // 初期に戻す
  document.getElementById('resetBtn').addEventListener('click', async ()=>{
    document.getElementById('loading').style.display = 'grid';
    state.popByName = await loadDefaultPopulation();
    recomputeBreaks();
    setLegend();
    state.layer.eachLayer(l=>{
      const name = state.nameByFid.get(L.stamp(l));
      const pop = state.popByName.get(name);
      l.setStyle({ fillColor: colorScale(pop, state.min, state.max) });
    });
    document.getElementById('loading').style.display = 'none';
  });

  boot();
  </script>
</body>
</html>
