// ğŸ› Indian Curry Map - Modern Single-Page Application
// 500å¹´ã®å¡æ™ºã§ä½œã‚‰ã‚ŒãŸã€ãŠã—ã‚ƒã‚Œãªã‚¤ãƒ³ãƒ‰ã‚«ãƒ¬ãƒ¼åº—ãƒãƒƒãƒ—
// 
// Dependencies: express, node-fetch@2, cheerio
// Install: npm i express node-fetch@2 cheerio
// Run: HOTPEPPER_KEY=your_key node app.js

const express = require('express');
const fetch = require('node-fetch');
const cheerio = require('cheerio');

// ğŸ¨ Configuration
const CONFIG = {
  PORT: process.env.PORT || 3000,
  HOTPEPPER_KEY: process.env.HOTPEPPER_KEY || '',
  SVG_URL: 'https://raw.githubusercontent.com/geolonia/japanese-prefectures/master/svg/japan.svg',
  OVERPASS_URL: 'https://overpass-api.de/api/interpreter',
  HOTPEPPER_BASE_URL: 'http://webservice.recruit.co.jp/hotpepper/gourmet/v1/',
  USER_AGENT: 'Indian-Curry-Map/2.0 (https://github.com/your-repo)'
};

// ğŸ—ºï¸ Prefecture mapping
const PREFECTURE_MAP = {
  'åŒ—æµ·é“': 'PREF01', 'é’æ£®çœŒ': 'PREF02', 'å²©æ‰‹çœŒ': 'PREF03', 'å®®åŸçœŒ': 'PREF04',
  'ç§‹ç”°çœŒ': 'PREF05', 'å±±å½¢çœŒ': 'PREF06', 'ç¦å³¶çœŒ': 'PREF07', 'èŒ¨åŸçœŒ': 'PREF08',
  'æ ƒæœ¨çœŒ': 'PREF09', 'ç¾¤é¦¬çœŒ': 'PREF10', 'åŸ¼ç‰çœŒ': 'PREF11', 'åƒè‘‰çœŒ': 'PREF12',
  'æ±äº¬éƒ½': 'PREF13', 'ç¥å¥ˆå·çœŒ': 'PREF14', 'æ–°æ½ŸçœŒ': 'PREF15', 'å¯Œå±±çœŒ': 'PREF16',
  'çŸ³å·çœŒ': 'PREF17', 'ç¦äº•çœŒ': 'PREF18', 'å±±æ¢¨çœŒ': 'PREF19', 'é•·é‡çœŒ': 'PREF20',
  'å²é˜œçœŒ': 'PREF21', 'é™å²¡çœŒ': 'PREF22', 'æ„›çŸ¥çœŒ': 'PREF23', 'ä¸‰é‡çœŒ': 'PREF24',
  'æ»‹è³€çœŒ': 'PREF25', 'äº¬éƒ½åºœ': 'PREF26', 'å¤§é˜ªåºœ': 'PREF27', 'å…µåº«çœŒ': 'PREF28',
  'å¥ˆè‰¯çœŒ': 'PREF29', 'å’Œæ­Œå±±çœŒ': 'PREF30', 'é³¥å–çœŒ': 'PREF31', 'å³¶æ ¹çœŒ': 'PREF32',
  'å²¡å±±çœŒ': 'PREF33', 'åºƒå³¶çœŒ': 'PREF34', 'å±±å£çœŒ': 'PREF35', 'å¾³å³¶çœŒ': 'PREF36',
  'é¦™å·çœŒ': 'PREF37', 'æ„›åª›çœŒ': 'PREF38', 'é«˜çŸ¥çœŒ': 'PREF39', 'ç¦å²¡çœŒ': 'PREF40',
  'ä½è³€çœŒ': 'PREF41', 'é•·å´çœŒ': 'PREF42', 'ç†Šæœ¬çœŒ': 'PREF43', 'å¤§åˆ†çœŒ': 'PREF44',
  'å®®å´çœŒ': 'PREF45', 'é¹¿å…å³¶çœŒ': 'PREF46', 'æ²–ç¸„çœŒ': 'PREF47'
};

// ğŸš€ Express app setup
const app = express();

// Middleware
app.use(express.json({ limit: '2mb' }));
app.use((req, res, next) => {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  next();
});

// ğŸ› ï¸ Utility functions
class Utils {
  static async fetchText(url, opts = {}) {
    const response = await fetch(url, {
      headers: { 'User-Agent': CONFIG.USER_AGENT },
      ...opts
    });
    if (!response.ok) {
      throw new Error(`Fetch failed: ${response.status} ${response.statusText}`);
    }
    return response.text();
  }

  static escapeHtml(str) {
    const map = {
      '&': '&amp;', '<': '&lt;', '>': '&gt;',
      '"': '&quot;', "'": '&#39;'
    };
    return String(str).replace(/[&<>"']/g, m => map[m]);
  }

  static normalizePrefecture(pref) {
    if (/^PREF\d{2}$/.test(pref)) return pref;
    if (/^\d{1,2}$/.test(pref)) return 'PREF' + pref.padStart(2, '0');
    return PREFECTURE_MAP[pref] || '';
  }

  static buildAddressFromTags(tags, fallbackPref) {
    const parts = [
      tags['addr:prefecture'] || fallbackPref || '',
      tags['addr:city'] || '',
      tags['addr:ward'] || '',
      tags['addr:street'] || '',
      tags['addr:housenumber'] || '',
      tags['addr:full'] || ''
    ].filter(Boolean);
    return Array.from(new Set(parts)).join(' ');
  }
}

// ğŸ› HotPepper API Service
class HotPepperService {
  static async searchShops(prefecture, keyword = 'ã‚¤ãƒ³ãƒ‰ã‚«ãƒ¬ãƒ¼') {
    if (!CONFIG.HOTPEPPER_KEY) {
      throw new Error('HotPepper API key not configured');
    }

    const prefParam = Utils.normalizePrefecture(prefecture);
    const params = new URLSearchParams({
      key: CONFIG.HOTPEPPER_KEY,
      format: 'json',
      keyword: keyword,
      count: '20'
    });

    if (prefParam) {
      params.append('pref', prefParam);
    }

    const url = `${CONFIG.HOTPEPPER_BASE_URL}?${params.toString()}`;
    const response = await fetch(url);
    const data = await response.json();
    
    return data;
  }
}

// ğŸ—ºï¸ Overpass API Service
class OverpassService {
  static async searchShops(prefecture) {
    const query = `
[out:json][timeout:25];
area["name"="${prefecture}"]["boundary"="administrative"]["admin_level"="4"]->.searchArea;
(
  node["amenity"="restaurant"]["cuisine"~"^indian$|^curry$"](area.searchArea);
  way["amenity"="restaurant"]["cuisine"~"^indian$|^curry$"](area.searchArea);
  relation["amenity"="restaurant"]["cuisine"~"^indian$|^curry$"](area.searchArea);
);
out tags center;`;

    const url = `${CONFIG.OVERPASS_URL}?data=${encodeURIComponent(query)}`;
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`Overpass API error: ${response.status}`);
    }
    
    return response.json();
  }
}

// ğŸ–¼ï¸ OGP Service
class OGPService {
  static async fetchImage(url) {
    try {
      const html = await Utils.fetchText(url);
      const $ = cheerio.load(html);
      
      const ogImage = $('meta[property="og:image"]').attr('content') ||
                     $('meta[name="twitter:image"]').attr('content');
      
      if (!ogImage) return null;
      
      return new URL(ogImage, url).href;
    } catch (error) {
      console.error('OGP fetch error:', error);
      return null;
    }
  }
}

// ğŸ¨ Frontend HTML with modern styling
const generateHTML = () => `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ğŸ› æ—¥æœ¬ã®ã‚¤ãƒ³ãƒ‰ã‚«ãƒ¬ãƒ¼åº—ãƒãƒƒãƒ— - 500å¹´ã®å¡æ™ºç‰ˆ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #111827;
      --bg-card: #1f2937;
      --accent-primary: #f59e0b;
      --accent-secondary: #fbbf24;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --border: #374151;
      --border-light: #4b5563;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-accent: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* ğŸ¨ Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 1.5rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    .header h1 {
      font-size: 1.875rem;
      font-weight: 700;
      background: var(--gradient-accent);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .header .subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 400;
    }

    /* ğŸ›ï¸ Controls */
    .controls {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover {
      background: var(--border);
      border-color: var(--accent-primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: var(--gradient-accent);
      border-color: var(--accent-primary);
      color: #000;
    }

    .btn-primary:hover {
      background: var(--accent-secondary);
    }

    .status {
      color: var(--text-muted);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-primary);
    }

    .status-indicator.inactive {
      background: var(--text-muted);
    }

    /* ğŸ—ºï¸ Map Container */
    .map-container {
      max-width: 1200px;
      margin: 0 auto 2rem;
      padding: 0 1.5rem;
    }

    .map-wrapper {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .map-wrapper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--gradient);
    }

    #svg-container {
      position: relative;
      z-index: 1;
    }

    svg {
      width: 100%;
      height: auto;
      display: block;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
    }

    /* ğŸ¯ Interactive Elements */
    .pref-hover {
      fill: var(--accent-primary) !important;
      cursor: pointer;
      transition: all 0.2s ease;
      filter: brightness(1.2);
    }

    .pref-hover:hover {
      filter: brightness(1.4) drop-shadow(0 0 10px rgba(245, 158, 11, 0.3));
    }

    /* ğŸ’¬ Tooltip */
    .tooltip {
      position: fixed;
      z-index: 9999;
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 1.5rem;
      border-radius: 1rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px);
      display: none;
      max-width: 480px;
      min-width: 320px;
      animation: tooltipFadeIn 0.2s ease-out;
    }

    @keyframes tooltipFadeIn {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .tooltip h3 {
      margin: 0 0 1rem;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--accent-primary);
    }

    .tooltip .stats {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: var(--bg-secondary);
      border-radius: 0.5rem;
      border: 1px solid var(--border-light);
    }

    .tooltip .stat {
      text-align: center;
    }

    .tooltip .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-primary);
    }

    .tooltip .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .tooltip .shop-info {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 0.75rem;
      border: 1px solid var(--border-light);
    }

    .tooltip .shop-name {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .tooltip .shop-address {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .tooltip .shop-photo {
      width: 100%;
      border-radius: 0.5rem;
      margin-top: 0.75rem;
      box-shadow: var(--shadow);
    }

    .tooltip .actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .tooltip .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    /* ğŸ“± Responsive Design */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.5rem;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn {
        justify-content: center;
      }
      
      .map-wrapper {
        padding: 1rem;
      }
      
      .tooltip {
        max-width: calc(100vw - 2rem);
        min-width: auto;
        margin: 0 1rem;
      }
    }

    /* ğŸ­ Loading States */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .loading::after {
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 0.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ğŸ¨ Error States */
    .error {
      background: #dc2626;
      color: #fef2f2;
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
      border: 1px solid #fca5a5;
    }

    /* ğŸŒŸ Animations */
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <h1>ğŸ› æ—¥æœ¬ã®ã‚¤ãƒ³ãƒ‰ã‚«ãƒ¬ãƒ¼åº—ãƒãƒƒãƒ—</h1>
      <p class="subtitle">500å¹´ã®å¡æ™ºã§ä½œã‚‰ã‚ŒãŸã€ãŠã—ã‚ƒã‚Œãªã‚«ãƒ¬ãƒ¼åº—æ¢ç´¢ãƒ„ãƒ¼ãƒ«</p>
    </div>
  </header>

  <div class="controls">
    <button class="btn btn-primary" id="btn-refresh">
      <span>ğŸ”„</span>
      ãƒãƒƒãƒ—å†èª­ã¿è¾¼ã¿
    </button>
    <button class="btn" id="btn-about">
      <span>â„¹ï¸</span>
      ä½¿ã„æ–¹
    </button>
    <div class="status">
      <div class="status-indicator ${CONFIG.HOTPEPPER_KEY ? '' : 'inactive'}"></div>
      <span>HotPepper API: ${CONFIG.HOTPEPPER_KEY ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</span>
    </div>
  </div>

  <div class="map-container">
    <div class="map-wrapper">
      <div id="svg-container" class="loading">åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>

  <div id="tooltip" class="tooltip" role="dialog" aria-live="polite"></div>

  <script>
    // ğŸ¯ Main Application Class
    class IndianCurryMap {
      constructor() {
        this.svgContainer = document.getElementById('svg-container');
        this.tooltip = document.getElementById('tooltip');
        this.serverBase = location.origin;
        this.svgUrl = '${CONFIG.SVG_URL}';
        this.isLoading = false;
        
        this.init();
      }

      async init() {
        this.attachEventListeners();
        await this.loadSvg();
      }

      attachEventListeners() {
        document.getElementById('btn-refresh').addEventListener('click', () => this.loadSvg());
        document.getElementById('btn-about').addEventListener('click', () => this.showAbout());
        
        // Close tooltip when clicking outside
        document.addEventListener('click', (e) => {
          if (!this.tooltip.contains(e.target) && !e.target.closest('[role="button"]')) {
            this.hideTooltip();
          }
        });

        // Close tooltip on escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') this.hideTooltip();
        });
      }

      async loadSvg() {
        if (this.isLoading) return;
        
        this.isLoading = true;
        this.svgContainer.innerHTML = '<div class="loading">åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        try {
          const response = await fetch(this.svgUrl);
          if (!response.ok) throw new Error('SVGå–å¾—å¤±æ•—: ' + response.status);
          
          const svgText = await response.text();
          const cleanSvg = svgText.replace(/<script[\\s\\S]*?<\\/script>/gi, '');
          
          this.svgContainer.innerHTML = cleanSvg;
          this.attachMapListeners();
          
          this.svgContainer.classList.add('fade-in');
        } catch (error) {
          this.svgContainer.innerHTML = '<div class="error"><strong>åœ°å›³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:</strong> ' + this.escapeHtml(error.message) + '</div>';
          console.error('SVG loading error:', error);
        } finally {
          this.isLoading = false;
        }
      }

      attachMapListeners() {
        const svg = this.svgContainer.querySelector('svg');
        if (!svg) return;

        const candidates = svg.querySelectorAll('[data-code], [data-name], path, g, polygon, rect');
        
        candidates.forEach(element => {
          const prefName = this.extractPrefectureName(element);
          if (prefName) {
            this.makeInteractive(element, prefName);
          }
        });
      }

      extractPrefectureName(element) {
        let pref = element.getAttribute('data-name') || 
                  element.getAttribute('data-pref') || 
                  element.getAttribute('data-code') || 
                  element.id || '';
        
        if (!pref) {
          const title = element.querySelector ? element.querySelector('title') : null;
          if (title) pref = title.textContent || '';
        }
        
        return pref.trim();
      }

      makeInteractive(element, prefName) {
        element.style.transition = 'all 0.2s ease';
        element.setAttribute('role', 'button');
        element.setAttribute('tabindex', '0');
        element.setAttribute('aria-label', prefName + 'ã®ã‚¤ãƒ³ãƒ‰ã‚«ãƒ¬ãƒ¼åº—ã‚’æ¤œç´¢');
        
        element.addEventListener('mouseenter', () => element.classList.add('pref-hover'));
        element.addEventListener('mouseleave', () => element.classList.remove('pref-hover'));
        element.addEventListener('click', (e) => this.onPrefectureClick(e, prefName, element));
        element.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.onPrefectureClick(e, prefName, element);
          }
        });
      }

      async onPrefectureClick(event, prefName, element) {
        event.stopPropagation();
        
        if (this.isLoading) return;
        
        this.showTooltipAt(event.clientX, event.clientY, '<div class="loading">' + prefName + 'ã®ã‚«ãƒ¬ãƒ¼åº—ã‚’æ¤œç´¢ä¸­...</div>');
        
        try {
          // Try HotPepper first
          const hotPepperData = await this.fetchHotPepper(prefName);
          if (hotPepperData && this.hasValidResults(hotPepperData)) {
            this.renderHotPepperResults(event.clientX, event.clientY, prefName, hotPepperData);
            return;
          }
          
          // Fallback to Overpass
          const overpassData = await this.fetchOverpass(prefName);
          this.renderOverpassResults(event.clientX, event.clientY, prefName, overpassData);
          
        } catch (error) {
          this.showTooltipAt(event.clientX, event.clientY, '<div class="error"><strong>æ¤œç´¢ã‚¨ãƒ©ãƒ¼:</strong> ' + this.escapeHtml(error.message) + '</div>');
        }
      }

      async fetchHotPepper(prefName) {
        const url = this.serverBase + '/api/hotpepper?pref=' + encodeURIComponent(prefName) + '&keyword=ã‚¤ãƒ³ãƒ‰ã‚«ãƒ¬ãƒ¼';
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error('HotPepper API ã‚¨ãƒ©ãƒ¼: ' + response.status);
        }
        
        return response.json();
      }

      async fetchOverpass(prefName) {
        const url = this.serverBase + '/api/overpass?pref=' + encodeURIComponent(prefName);
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error('Overpass API ã‚¨ãƒ©ãƒ¼: ' + response.status);
        }
        
        return response.json();
      }

      hasValidResults(data) {
        return data && (
          (data.results && data.results.shop && data.results.shop.length > 0) ||
          data.total_hit_count > 0
        );
      }

      renderHotPepperResults(x, y, prefName, data) {
        const total = data.results.results_available || data.total_hit_count || 
                     (data.results.shop ? data.results.shop.length : 0);
        const shops = data.results.shop || [];
        const firstShop = shops[0];

        let html = '<h3>ğŸ› ' + this.escapeHtml(prefName) + '</h3>';
        html += '<div class="stats">';
        html += '<div class="stat"><div class="stat-value">' + total + '</div><div class="stat-label">åº—èˆ—æ•°</div></div>';
        html += '<div class="stat"><div class="stat-value">' + shops.length + '</div><div class="stat-label">è¡¨ç¤ºä¸­</div></div>';
        html += '</div>';

        if (firstShop) {
          html += '<div class="shop-info">';
          html += '<div class="shop-name">' + this.escapeHtml(firstShop.name) + '</div>';
          html += '<div class="shop-address">ğŸ“ ' + this.escapeHtml(firstShop.address) + '</div>';
          
          if (firstShop.photo && firstShop.photo.mobile && firstShop.photo.mobile.s) {
            html += '<img class="shop-photo" src="' + firstShop.photo.mobile.s + '" alt="' + this.escapeHtml(firstShop.name) + '">';
          }
          
          html += '<div class="actions">';
          if (firstShop.urls && firstShop.urls.pc) {
            html += '<button class="btn btn-small" onclick="window.open(\'' + firstShop.urls.pc + '\', \'_blank\')">ğŸª åº—èˆ—ãƒšãƒ¼ã‚¸</button>';
            html += '<button class="btn btn-small" onclick="fetchOGPAndShow(\'' + encodeURIComponent(firstShop.urls.pc) + '\')">ğŸ–¼ï¸ OGPç”»åƒ</button>';
          }
          html += '</div>';
          html += '</div>';
        } else {
          html += '<div class="shop-info">';
          html += '<div class="shop-name">åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
          html += '<div class="shop-address">ä»–ã®åœ°åŸŸã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„</div>';
          html += '</div>';
        }

        this.showTooltipAt(x, y, html);
      }

      renderOverpassResults(x, y, prefName, data) {
        const elements = data.elements || [];
        const count = elements.length;
        const firstElement = elements[0];

        let html = '<h3>ğŸ—ºï¸ ' + this.escapeHtml(prefName) + ' (OpenStreetMap)</h3>';
        html += '<div class="stats">';
        html += '<div class="stat"><div class="stat-value">' + count + '</div><div class="stat-label">åº—èˆ—æ•°</div></div>';
        html += '</div>';

        if (count > 0 && firstElement) {
          const name = (firstElement.tags && firstElement.tags.name) ? firstElement.tags.name : '(åº—åä¸æ˜)';
          const address = this.buildAddressFromTags(firstElement.tags || {}, prefName);
          const lat = firstElement.lat || (firstElement.center && firstElement.center.lat);
          const lon = firstElement.lon || (firstElement.center && firstElement.center.lon);

          html += '<div class="shop-info">';
          html += '<div class="shop-name">' + this.escapeHtml(name) + '</div>';
          html += '<div class="shop-address">ğŸ“ ' + this.escapeHtml(address) + '</div>';
          
          if (lat && lon) {
            html += '<div class="actions">';
            html += '<button class="btn btn-small" onclick="window.open(\'https://www.openstreetmap.org/?mlat=' + lat + '&mlon=' + lon + '#map=18/' + lat + '/' + lon + '\', \'_blank\')">ğŸ—ºï¸ åœ°å›³ã§è¦‹ã‚‹</button>';
            html += '</div>';
          }
          html += '</div>';
        } else {
          html += '<div class="shop-info">';
          html += '<div class="shop-name">åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
          html += '<div class="shop-address">ä»–ã®åœ°åŸŸã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„</div>';
          html += '</div>';
        }

        this.showTooltipAt(x, y, html);
      }

      buildAddressFromTags(tags, fallbackPref) {
        const parts = [
          tags['addr:prefecture'] || fallbackPref || '',
          tags['addr:city'] || '',
          tags['addr:ward'] || '',
          tags['addr:street'] || '',
          tags['addr:housenumber'] || '',
          tags['addr:full'] || ''
        ].filter(Boolean);
        return Array.from(new Set(parts)).join(' ');
      }

      showTooltipAt(x, y, html) {
        this.tooltip.style.display = 'block';
        this.tooltip.innerHTML = html;
        
        const padding = 16;
        const tooltipWidth = this.tooltip.offsetWidth;
        const tooltipHeight = this.tooltip.offsetHeight;
        
        let tooltipX = x + padding;
        let tooltipY = y + padding;
        
        // Adjust position if tooltip goes off screen
        if (tooltipX + tooltipWidth > window.innerWidth) {
          tooltipX = x - tooltipWidth - padding;
        }
        if (tooltipY + tooltipHeight > window.innerHeight) {
          tooltipY = y - tooltipHeight - padding;
        }
        
        // Ensure tooltip stays within viewport
        tooltipX = Math.max(padding, Math.min(tooltipX, window.innerWidth - tooltipWidth - padding));
        tooltipY = Math.max(padding, Math.min(tooltipY, window.innerHeight - tooltipHeight - padding));
        
        this.tooltip.style.left = tooltipX + 'px';
        this.tooltip.style.top = tooltipY + 'px';
      }

      hideTooltip() {
        this.tooltip.style.display = 'none';
      }

      showAbout() {
        const aboutHtml = '<h3>â„¹ï¸ ä½¿ã„æ–¹</h3>' +
          '<div class="shop-info">' +
          '<div class="shop-name">ğŸ› ã‚¤ãƒ³ãƒ‰ã‚«ãƒ¬ãƒ¼åº—ãƒãƒƒãƒ—</div>' +
          '<div class="shop-address">' +
          '<p>1. åœ°å›³ä¸Šã®éƒ½é“åºœçœŒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>' +
          '<p>2. HotPepper APIãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯å„ªå…ˆçš„ã«ä½¿ç”¨ã•ã‚Œã¾ã™</p>' +
          '<p>3. åˆ©ç”¨ã§ããªã„å ´åˆã¯OpenStreetMapã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™</p>' +
          '<p>4. åº—èˆ—æƒ…å ±ã‚„å†™çœŸãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>' +
          '</div>' +
          '<div class="actions">' +
          '<button class="btn btn-small" onclick="this.closest(\'.tooltip\').style.display=\'none\'">é–‰ã˜ã‚‹</button>' +
          '</div>' +
          '</div>';
        
        this.showTooltipAt(window.innerWidth / 2, window.innerHeight / 2, aboutHtml);
      }

      escapeHtml(str) {
        const map = {
          '&': '&amp;', '<': '&lt;', '>': '&gt;',
          '"': '&quot;', "'": '&#39;'
        };
        return String(str).replace(/[&<>"']/g, m => map[m]);
      }
    }

    // ğŸš€ Initialize the application
    window.fetchOGPAndShow = async function(encodedUrl) {
      try {
        const rawUrl = decodeURIComponent(encodedUrl);
        const response = await fetch(window.location.origin + '/api/ogp?url=' + encodeURIComponent(rawUrl));
        
        if (!response.ok) {
          throw new Error('OGPå–å¾—ã‚¨ãƒ©ãƒ¼: ' + response.status);
        }
        
        const data = await response.json();
        
        if (data.image) {
          const tooltip = document.getElementById('tooltip');
          tooltip.innerHTML = '<div style="text-align: center;"><img class="shop-photo" src="' + data.image + '" alt="åº—èˆ—ç”»åƒ"><div style="margin-top: 0.75rem; color: var(--text-secondary);">OGPç”»åƒ</div></div>';
          tooltip.style.display = 'block';
          tooltip.style.left = '50%';
          tooltip.style.top = '50%';
          tooltip.style.transform = 'translate(-50%, -50%)';
        } else {
          alert('OGPç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        }
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    };

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      new IndianCurryMap();
    });
  </script>
</body>
</html>`;

// ğŸ›£ï¸ Routes
app.get('/', (req, res) => {
  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(generateHTML());
});

app.get('/api/hotpepper', async (req, res) => {
  try {
    const prefRaw = req.query.pref || '';
    const keyword = req.query.keyword || 'ã‚¤ãƒ³ãƒ‰ã‚«ãƒ¬ãƒ¼';
    
    if (!CONFIG.HOTPEPPER_KEY) {
      return res.status(400).json({ 
        error: 'HotPepper API key not configured on server.' 
      });
    }

    const data = await HotPepperService.searchShops(prefRaw, keyword);
    res.json(data);
  } catch (error) {
    console.error('HotPepper API error:', error);
    res.status(500).json({ error: error.message });
  }
});

app.get('/api/ogp', async (req, res) => {
  try {
    const url = req.query.url;
    if (!url) {
      return res.status(400).json({ error: 'URL parameter required' });
    }

    const imageUrl = await OGPService.fetchImage(url);
    res.json({ image: imageUrl });
  } catch (error) {
    console.error('OGP fetch error:', error);
    res.status(500).json({ error: error.message });
  }
});

app.get('/api/overpass', async (req, res) => {
  try {
    const pref = req.query.pref || '';
    if (!pref) {
      return res.status(400).json({ error: 'Prefecture parameter required' });
    }

    const data = await OverpassService.searchShops(pref);
    res.json(data);
  } catch (error) {
    console.error('Overpass API error:', error);
    res.status(500).json({ error: error.message });
  }
});

// ğŸš€ Start the server
app.listen(CONFIG.PORT, () => {
  console.log('ğŸ› Indian Curry Map Server running on http://localhost:' + CONFIG.PORT);
  console.log('âœ¨ 500å¹´ã®å¡æ™ºãŒå®¿ã‚‹ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãŸã®ã˜ã‚ƒï¼');
  
  if (!CONFIG.HOTPEPPER_KEY) {
    console.log('âš ï¸  Note: HOTPEPPER_KEY not set â€” HotPepper API calls will return error. Overpass/OGP still work.');
  }
});
